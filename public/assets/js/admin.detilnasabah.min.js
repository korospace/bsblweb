const getTotalSampahNasabah=async()=>{let a=await httpRequestGet(`${APIURL}/sampah/totalitem?idnasabah=${IDNASABAH}`);if(200===a.status){let t=a.data.data;for(const a in t)$(`#sampah-${a}`).html(t[a].total+" Kg")}};let currentYear="",currentMonth="";$(".filter-transaksi").on("input",function(a){4==$("#filter-year").val().length&&(chartGrafik.destroy(),currentYear=$("#filter-year").val(),currentMonth=$("#filter-month").val(),getAllTransaksiNasabah(`${currentMonth}-${currentYear}`))});const getAllTransaksiNasabah=async a=>{$(".spinner-wraper").removeClass("d-none"),$("#transaksi-wraper").addClass("d-none");let t=await httpRequestGet(`${APIURL}/transaksi/getdata?idnasabah=${IDNASABAH}&date=${a}`);if($(".spinner-wraper").addClass("d-none"),$("#transaksi-wraper").removeClass("d-none"),404===t.status)updateGrafikSetorNasabah([],[]),$("#transaksi-wraper").html("<h6 class='opacity-6'>belum ada transaksi</h6>");else if(200===t.status){let a=[],e=[],s="",n=t.data.data;n.forEach(t=>{let n=t.type,r=t.jenis_saldo,i="",l=new Date(1e3*parseInt(t.date)),o=l.toLocaleString("en-US",{day:"numeric"}),d=l.toLocaleString("en-US",{month:"long"}),h=l.toLocaleString("en-US",{year:"numeric"}),m="";"setor"==n?(i="text-success",m="+Rp"+modifUang(t[`total_${n}`]),a.push(t.id_transaksi),e.push(t.total_kg)):"tarik"==n?(i="text-danger",m="uang"==r?"-Rp"+modifUang(t[`total_${n}`]):"-"+t[`total_${n}`]+"g"):(i="text-warning",m="uang"==r?'<i class="fas fa-exchange-alt"></i> Rp'+modifUang(t[`total_${n}`]):t[`total_${n}`]+"g"),s+=`<li class="list-group-item border-0 ps-0 border-radius-lg">\n            <div class="d-flex justify-content-between">\n                <div class="d-flex flex-column">\n                    <h6 class="mb-1 text-dark font-weight-bold text-sm">${d}, ${o}, ${h}</h6>\n                    <span class="text-xs">ID: ${t.id_transaksi}</span>\n                    <span class="${i} mt-2">${m}</span>\n                </div>\n                <div class="d-flex align-items-center text-sm">\n                    <a href='' class="btn btn-link text-dark text-sm mb-0 p-2 text-sm bg-info border-radius-sm"  data-toggle="modal" data-target="#modalPrintTransaksi" onclick="getDetailTransaksiNasabah('${t.id_transaksi}');">\n                        <i class="fas fa-file-pdf text-xs text-white"></i>\n                    </a>\n                    <a href='' class="btn btn-link text-dark text-sm mb-0 p-2 ml-1 text-sm bg-danger border-radius-sm" onclick="deleteTransaksiNasabah('${t.id_transaksi}',event);">\n                        <i class="fas fa-trash text-xs text-white"></i>\n                    </a>\n                </div>\n            </div>\n            <hr class="horizontal dark mt-2">\n        </li>`}),updateGrafikSetorNasabah(a,e),$("#transaksi-wraper").html(`<ul class="list-group h-100 w-100" style="font-family: 'qc-medium';">\n            ${s}\n        </ul>`)}};let chartGrafik="";const updateGrafikSetorNasabah=(a,t)=>{var e=document.getElementById("chart-line").getContext("2d");document.querySelector("#chart-line").style.width="100%",document.querySelector("#chart-line").style.maxHeight="300px";var s=e.createLinearGradient(0,230,0,50);s.addColorStop(1,"rgba(193,217,102,0.2)");var n=e.createLinearGradient(0,230,0,50);n.addColorStop(1,"rgba(193,217,102,0.2)");for(let t=a.length;t<10;t++)a.push(" ");chartGrafik=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Kg",tension:.4,borderWidth:0,pointRadius:0,borderColor:"#c1d966",borderWidth:3,backgroundColor:s,fill:!0,data:t,maxBarThickness:6,minBarLength:6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{grid:{drawBorder:!1,display:!0,drawOnChartArea:!0,drawTicks:!1,borderDash:[5,5]},ticks:{display:!0,padding:10,color:"#b2b9bf",beginAtZero:!0,font:{size:11,family:"Open Sans",style:"normal",lineHeight:2}}},x:{grid:{drawBorder:!1,display:!1,drawOnChartArea:!1,drawTicks:!1,borderDash:[5,5]},ticks:{display:!0,color:"#b2b9bf",padding:0,font:{size:11,family:"Open Sans",style:"normal",lineHeight:2}}}}}})},getDetailTransaksiNasabah=async a=>{$("#detil-transaksi-body").html(" "),$("#detil-transaksi-spinner").removeClass("d-none");let t=await httpRequestGet(`${APIURL}/transaksi/getdata?id_transaksi=${a}`);if(200===t.status){$("#detil-transaksi-spinner").addClass("d-none");let a=new Date(1e3*parseInt(t.data.data.date));if($("#detil-transaksi-date").html(`${a.toLocaleString("en-US",{day:"numeric"})}/${a.toLocaleString("en-US",{month:"numeric"})}/${a.toLocaleString("en-US",{year:"numeric"})}&nbsp;&nbsp;&nbsp;${a.toLocaleString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}`),$("#detil-transaksi-nama").html(t.data.data.nama_lengkap),$("#detil-transaksi-idnasabah").html(t.data.data.id_nasabah),$("#detil-transaksi-idtransaksi").html(t.data.data.id_transaksi),$("#detil-transaksi-type").html("setor"==t.data.data.type?t.data.data.type+" sampah":t.data.data.type+" saldo"),$("#btn-cetak-transaksi").attr("href",`${BASEURL}/nasabah/cetaktransaksi/${t.data.data.id_transaksi}`),"tarik"==t.data.data.type){let a=t.data.data.jenis_saldo,e="uang"==a?"Rp "+modifUang(t.data.data.jumlah):t.data.data.jumlah+" gram";$("#detil-transaksi-body").html(`<div class="p-4 bg-secondary border-radius-sm">\n                <table>\n                    <tr class="text-dark">\n                        <td><h4>Jenis saldo&nbsp;</h4></td>\n                        <td><h4>: &nbsp;&nbsp;${"uang"==a?a:"emas "+a}</h4></td>\n                    </tr>\n                    <tr class="text-dark">\n                        <td><h4>Jumlah</h4></td>\n                        <td><h4>: &nbsp;&nbsp;${e}</h4></td>\n                    </tr>\n                </table>\n            </div>`)}if("pindah"==t.data.data.type){let a="uang"==t.data.data.jenis_saldo?"Rp "+modifUang(t.data.data.jumlah):t.data.data.jumlah+" gram",e="uang"!==t.data.data.asal?"Rp "+modifUang(t.data.data.hasil_konversi):t.data.data.hasil_konversi+" gram";$("#detil-transaksi-body").html(`<div class="p-4 bg-secondary border-radius-sm">\n            <table>\n                <tr class="text-dark">\n                    <td>Saldo asal</td>\n                    <td>: &nbsp;&nbsp;${t.data.data.asal}</td>\n                </tr>\n                <tr class="text-dark">\n                    <td>Saldo tujuan</td>\n                    <td>: &nbsp;&nbsp;${t.data.data.tujuan}</td>\n                </tr>\n                <tr class="text-dark">\n                    <td>Jumlah</td>\n                    <td>: &nbsp;&nbsp;${a}</td>\n                </tr>\n                <tr class="text-dark">\n                    <td>Harga emas</td>\n                    <td>: &nbsp;&nbsp;Rp ${modifUang(t.data.data.harga_emas)}</td>\n                </tr>\n                <tr class="text-dark">\n                    <td>Hasil konversi&nbsp;</td>\n                    <td>: &nbsp;&nbsp;${e}</td>\n                </tr>\n            </table>\n            </div>`)}if("setor"==t.data.data.type){let a="",e=t.data.data.barang;e.forEach((t,e)=>{a+=`<tr class="text-center">\n                    <th scope="row">${++e}</th>\n                    <td>${t.jenis_sampah}</td>\n                    <td>${t.jumlah}</td>\n                    <td>Rp ${modifUang(t.harga)}</td>\n                </tr>`}),$("#detil-transaksi-body").html(`<table class="table table-striped">\n                <thead>\n                    <tr>\n                        <th scope="col">#</th>\n                        <th scope="col">Jenis sampah</th>\n                        <th scope="col">Jumlah</th>\n                        <th scope="col">Harga</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${a}\n                </tbody>\n            </table>`)}}},getDataProfileNasabah=async()=>{let a=await httpRequestGet(`${APIURL}/admin/getnasabah?id=${IDNASABAH}`);if(404==a.status&&Swal.fire({icon:"error",title:"<strong>NOT FOUND</strong>",text:`nasabah dengan id ${IDNASABAH} tidak ditemukan!`,showCancelButton:!1,confirmButtonText:"ok"}).then(()=>{window.location.replace(`${BASEURL}/admin/listnasabah`)}),200===a.status){let t=a.data.data,e=new Date(1e3*parseInt(t.created_at));$("#card-id").html(`${t.id.slice(0,5)}&nbsp;&nbsp;&nbsp;${t.id.slice(5,9)}&nbsp;&nbsp;&nbsp;${t.id.slice(9,99999999)}`),$("#card-username").html(t.username),$("#card-date").html(`${e.toLocaleString("en-US",{day:"numeric"})}/${e.toLocaleString("en-US",{month:"numeric"})}/${e.toLocaleString("en-US",{year:"numeric"})}`),$("#saldo-uang").html(modifUang(t.saldo_uang)),$("#saldo-ubs").html(parseFloat(t.saldo_ubs).toFixed(4)),$("#saldo-antam").html(parseFloat(t.saldo_antam).toFixed(4)),$("#saldo-galery24").html(parseFloat(t.saldo_galery24).toFixed(4)),$("#personal-info #email").html(t.email),$("#personal-info #nama-lengkap").html(t.nama_lengkap),$("#personal-info #username").html(t.username),$("#personal-info #tgl-lahir").html(t.tgl_lahir),$("#personal-info #kelamin").html(t.kelamin),$("#personal-info #alamat").html(t.alamat),$("#personal-info #notelp").html(t.notelp)}},deleteTransaksiNasabah=(a,t)=>{t.preventDefault(),Swal.fire({title:"ANDA YAKIN?",text:"Data akan terhapus permanen",icon:"warning",showCancelButton:!0,confirmButtonText:"iya"}).then(t=>{t.isConfirmed&&Swal.fire({input:"password",inputAttributes:{autocapitalize:"off"},html:"<h5 class='mb-4'>Password</h5>",showCancelButton:!0,confirmButtonText:"submit",showLoaderOnConfirm:!0,preConfirm:t=>{let e=new FormData;return e.append("hashedpass",PASSADMIN),e.append("password",t),axios.post(`${APIURL}/admin/confirmdelete`,e,{headers:{}}).then(t=>httpRequestDelete(`${APIURL}/transaksi/deleteitem?id=${a}`).then(a=>{201==a.status&&(chartGrafik.destroy(),getAllTransaksiNasabah(`${currentMonth}-${currentYear}`),getTotalSampahNasabah())})).catch(a=>{404==a.response.status?Swal.showValidationMessage("password salah"):500==a.response.status&&Swal.showValidationMessage("terjadi kesalahan, coba sekali lagi")})},allowOutsideClick:()=>!Swal.isLoading()})})},openModalSetorSaldo=()=>{$("#formSetorSampah .form-control").removeClass("is-invalid"),$("#formSetorSampah .text-danger").html(""),$("#formSetorSampah .form-control").val(""),$(".barisSetorSampah").remove(),tambahBaris()};let arrayJenisSampah=[];const getAllJenisSampah=async()=>{let a=await httpRequestGet(`${APIURL}/sampah/getitem`);200===a.status&&(arrayJenisSampah=sortingSampah(a.data.data)),tambahBaris()};getAllJenisSampah();const sortingSampah=a=>{let t=[],e={},s=[];a.forEach(a=>{t.includes(a.kategori)||t.push(a.kategori.replace(/\s/g,"_"))}),t.forEach(t=>{e[t]=a.filter(a=>a.kategori==t.replace(/_/g," "))});for(let a in e)e[a].forEach(a=>{s.push(a)});return s},tambahBaris=(a=!1)=>{a&&a.preventDefault();let t="<option value='' data-harga='0' selected>-- pilih jenis sampah  --</option>";0!==arrayJenisSampah.length&&arrayJenisSampah.forEach(a=>{t+=`<option value="${a.jenis}" data-harga="${a.harga}">${a.kategori} - ${a.jenis}</option>`});let e=$(".barisSetorSampah").size(),s=` <td class="py-2" style="border-right: 0.5px solid #E9ECEF;">\n        <span class="w-100 btn btn-danger d-flex justify-content-center align-items-center border-radius-sm" style="height: 38px;margin: 0;" onclick="hapusBaris(this);">\n            <i class="fas fa-times text-white"></i>\n        </span>\n    </td>\n    <td class="py-2" style="border-right: 0.5px solid #E9ECEF;">\n        <select id="kategori-berita-wraper" class="inputJenisSampah form-control form-control-sm py-1 pl-2 border-radius-sm" name="transaksi[slot${e+1}][jenis_sampah]" style="min-height: 38px" onchange="getHargaInOption(this,event);">\n            ${t}\n        </select>\n    </td>\n    <td class="py-2" style="border-right: 0.5px solid #E9ECEF;">\n        <input type="text" class="inputJumlahSampah form-control form-control-sm pl-2 border-radius-sm" value="0" name="transaksi[slot${e+1}][jumlah]" style="min-height: 38px" onkeyup="countHargaXjumlah(this);">\n    </td>\n    <td class="py-2">\n        <input type="text" class="inputHargaSampah form-control form-control-sm pl-2 border-radius-sm" style="min-height: 38px" data-harga="0" value="0" disabled>\n    </td>`,n=document.createElement("tr");n.classList.add("barisSetorSampah"),n.innerHTML=s,document.querySelector("#table-setor-sampah tbody").insertBefore(n,document.querySelector("#special-tr"))},hapusBaris=a=>{a.parentElement.parentElement.remove(),countTotalHarga()},getHargaInOption=(a,t)=>{var e=t.target.options[t.target.selectedIndex].dataset.harga;let s=a.parentElement.nextElementSibling.children[0];s.value=1;let n=a.parentElement.nextElementSibling.nextElementSibling.children[0];n.value=e,n.setAttribute("data-harga",e),countTotalHarga()},countHargaXjumlah=a=>{var t=a.value;let e=a.parentElement.previousElementSibling.children[0];if(""!==e.value&&""!==t){let e=a.parentElement.nextElementSibling.children[0],s=e.getAttribute("data-harga");e.value=parseFloat(t)*parseFloat(s),countTotalHarga()}},countTotalHarga=()=>{let a=0;$(".inputHargaSampah").each(function(){a+=parseFloat($(this).val())}),$("#special-tr #total-harga").html(modifUang(a.toString()))},validateSetorSampah=()=>{let a=!0,t="";return $("#formSetorSampah .form-control").removeClass("is-invalid"),$("#formSetorSampah .text-danger").html(""),""==$("#formSetorSampah #date").val()&&($("#formSetorSampah #date").addClass("is-invalid"),$("#formSetorSampah #date-error").html("*tanggal harus di isi"),a=!1),$(".inputJenisSampah").each(function(){""==$(this).val()&&($(this).addClass("is-invalid"),a=!1,t="input tidak boleh kosong!")}),$(".inputJumlahSampah").each(function(){""==$(this).val()&&($(this).addClass("is-invalid"),a=!1,t="input tidak boleh kosong!"),/[^0-9\.]/g.test($(this).val())&&($(this).addClass("is-invalid"),a=!1,t="jumlah hanya boleh berupa angka positif dan titik!")}),0==a&&""!==t&&(showAlert({message:`<strong>${t}</strong>`,btnclose:!1,type:"danger"}),setTimeout(()=>{hideAlert()},3e3)),a},openModalPindahSaldo=()=>{$("#formPindahSaldo .form-check-input").removeClass("is-invalid"),$("#formPindahSaldo .form-control").removeClass("is-invalid"),$("#formPindahSaldo .form-check-input").prop("checked",!1),$("#formPindahSaldo .text-danger").html(""),$("#formPindahSaldo .form-control").val("")},validatePindahSaldo=()=>{let a=!0,t=new FormData(document.querySelector("#formPindahSaldo"));return $("#formPindahSaldo .form-check-input").removeClass("is-invalid"),$("#formPindahSaldo .form-control").removeClass("is-invalid"),$("#formPindahSaldo .text-danger").html(""),""==$("#formPindahSaldo #date").val()&&($("#formPindahSaldo #date").addClass("is-invalid"),$("#formPindahSaldo #date-error").html("*tanggal harus di isi"),a=!1),""==$("#formPindahSaldo #harga_emas").val()?($("#formPindahSaldo #harga_emas").addClass("is-invalid"),$("#formPindahSaldo #harga_emas-error").html("*harga emas harus di isi"),a=!1):/[^0-9\.]/g.test($("#formPindahSaldo #harga_emas").val())&&($("#formPindahSaldo #harga_emas").addClass("is-invalid"),$("#formPindahSaldo #harga_emas-error").html("*hanya boleh berupa angka positif dan titik!"),a=!1),""==$("#formPindahSaldo #jumlah").val()?($("#formPindahSaldo #jumlah").addClass("is-invalid"),$("#formPindahSaldo #jumlah-error").html("*jumlah saldo harus di isi"),a=!1):/[^0-9\.]/g.test($("#formPindahSaldo #jumlah").val())?($("#formPindahSaldo #jumlah").addClass("is-invalid"),$("#formPindahSaldo #jumlah-error").html("*hanya boleh berupa angka positif dan titik!"),a=!1):parseFloat($("#formPindahSaldo #jumlah").val())<1e4&&($("#formPindahSaldo #jumlah").addClass("is-invalid"),$("#formPindahSaldo #jumlah-error").html("*minimal Rp.10,000"),a=!1),null==t.get("tujuan")&&($("#formPindahSaldo .form-check-input").addClass("is-invalid"),a=!1),a},openModalTarikSaldo=()=>{$("#formTarikSaldo .form-check-input").removeClass("is-invalid"),$("#formTarikSaldo .form-control").removeClass("is-invalid"),$("#formTarikSaldo .form-check-input").prop("checked",!1),$("#formTarikSaldo .text-danger").html(""),$("#formTarikSaldo .form-control").val("")},validateTarikSaldo=()=>{let a=!0,t=new FormData(document.querySelector("#formTarikSaldo"));return $("#formTarikSaldo .form-check-input").removeClass("is-invalid"),$("#formTarikSaldo .form-control").removeClass("is-invalid"),$("#formTarikSaldo .text-danger").html(""),""==$("#formTarikSaldo #date").val()&&($("#formTarikSaldo #date").addClass("is-invalid"),$("#formTarikSaldo #date-error").html("*tanggal harus di isi"),a=!1),null==t.get("jenis_saldo")&&($("#formTarikSaldo .form-check-input").addClass("is-invalid"),a=!1),""==$("#formTarikSaldo #jumlah").val()?($("#formTarikSaldo #jumlah").addClass("is-invalid"),$("#formTarikSaldo #jumlah-error").html("*jumlah saldo harus di isi"),a=!1):/[^0-9\.]/g.test($("#formTarikSaldo #jumlah").val())&&($("#formTarikSaldo #jumlah").addClass("is-invalid"),$("#formTarikSaldo #jumlah-error").html("*hanya boleh berupa angka positif dan titik!"),a=!1),a},doTransaksi=async(a,t,e)=>{t.preventDefault();let s="",n=a.parentElement.parentElement.parentElement,r="";if("setorsampah"==e?(s=validateSetorSampah,r="setor sampah"):"pindahsaldo"==e?(s=validatePindahSaldo,r="pindah saldo"):"tariksaldo"==e&&(s=validateTarikSaldo,r="tarik saldo"),s()){Swal.fire({input:"password",inputAttributes:{autocapitalize:"off"},html:"<h5 class='mb-4'>Password</h5>",showCancelButton:!0,confirmButtonText:"submit",showLoaderOnConfirm:!0,preConfirm:t=>{let e=new FormData;return e.append("hashedpass",PASSADMIN),e.append("password",t),axios.post(`${APIURL}/admin/confirmdelete`,e,{headers:{}}).then(t=>{a()}).catch(a=>{404==a.response.status?Swal.showValidationMessage("password salah"):500==a.response.status&&Swal.showValidationMessage("terjadi kesalahan, coba sekali lagi")})},allowOutsideClick:()=>!Swal.isLoading()});let a=async()=>{let a=new FormData(n),t=a.get("date").split("-");a.set("date",`${t[2]}-${t[1]}-${t[0]}`),showLoadingSpinner(),httpResponse=await httpRequestPost(`${APIURL}/transaksi/${e}`,a),hideLoadingSpinner(),201===httpResponse.status?(chartGrafik.destroy(),currentMonth=(new Date).toLocaleString("en-US",{month:"numeric"}),currentYear=(new Date).toLocaleString("en-US",{year:"numeric"}),$(`#filter-month option[value=${currentMonth}]`).attr("selected","selected"),$("#filter-year").val(currentYear),getAllTransaksiNasabah(`${currentMonth}-${currentYear}`),getDataProfileNasabah(),"setorsampah"==e&&($(".barisSetorSampah").remove(),tambahBaris(),getTotalSampahNasabah(),countTotalHarga()),$(".form-control").val(""),$(".form-check-input").prop("checked",!1),showAlert({message:`<strong>Success...</strong> ${r} berhasil!`,btnclose:!1,type:"success"}),setTimeout(()=>{hideAlert()},3e3)):400===httpResponse.status&&httpResponse.message.jumlah&&("pindahsaldo"==e?($("#formPindahSaldo #jumlah").addClass("is-invalid"),$("#formPindahSaldo #jumlah-error").html(`*${httpResponse.message.jumlah}`)):($("#formTarikSaldo #jumlah").addClass("is-invalid"),$("#formTarikSaldo #jumlah-error").html(`*${httpResponse.message.jumlah}`)))}}};